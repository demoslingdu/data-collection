# æ¥å£å‚æ•°æ–‡æ¡£è¡¥å……

## æ–‡æ¡£ä¿¡æ¯

- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
- **åˆ›å»ºæ—¥æœŸ**: 2024-01-22
- **æ¥å£æ•°é‡**: 2ä¸ª
- **é€‚ç”¨ç³»ç»Ÿ**: æ•°æ®æ”¶é›†ç®¡ç†ç³»ç»Ÿ

## ç›®å½•

1. [åˆ›å»ºæ•°æ®è®°å½•æ¥å£](#1-åˆ›å»ºæ•°æ®è®°å½•æ¥å£)
2. [å›¾ç‰‡ä¸Šä¼ æ¥å£](#2-å›¾ç‰‡ä¸Šä¼ æ¥å£)

---

## 1. åˆ›å»ºæ•°æ®è®°å½•æ¥å£

### 1.1 æ¥å£ä¿¡æ¯

- **æ¥å£è·¯å¾„**: `POST /api/data-records`
- **æ¥å£æè¿°**: åˆ›å»ºæ–°çš„æ•°æ®è®°å½•ï¼Œæ”¯æŒè‡ªåŠ¨å»é‡æ£€æµ‹
- **è®¤è¯è¦æ±‚**: éœ€è¦Bearer Tokenè®¤è¯
- **è¯·æ±‚æ–¹å¼**: POST
- **Content-Type**: `application/json`

### 1.2 è¯·æ±‚å¤´

```
Authorization: Bearer {token}
Content-Type: application/json
```

### 1.3 è¯·æ±‚å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| image_url | string | æ˜¯ | å›¾ç‰‡URLåœ°å€ |
| platform | string | æ˜¯ | æ¥æºå¹³å° |
| platform_id | string | æ˜¯ | å¹³å°ID |

#### å‚æ•°éªŒè¯è§„åˆ™

- `image_url`: 
  - å¿…å¡«å­—æ®µ
  - å¿…é¡»æ˜¯æœ‰æ•ˆçš„URLæ ¼å¼
  - ç¤ºä¾‹ï¼š`https://example.com/image.jpg`

- `platform`: 
  - å¿…å¡«å­—æ®µ
  - æšä¸¾å€¼ï¼š`douyin`ï¼ˆæŠ–éŸ³ï¼‰ã€`xiaohongshu`ï¼ˆå°çº¢ä¹¦ï¼‰ã€`taobao`ï¼ˆæ·˜å®ï¼‰ã€`xianyu`ï¼ˆé—²é±¼ï¼‰

- `platform_id`: 
  - å¿…å¡«å­—æ®µ
  - å­—ç¬¦ä¸²ç±»å‹
  - æœ€å¤§é•¿åº¦ï¼š255ä¸ªå­—ç¬¦
  - ç”¨äºæ ‡è¯†å¹³å°ä¸Šçš„å…·ä½“å†…å®¹

#### å»é‡è§„åˆ™

ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹é‡å¤è®°å½•ï¼š

1. **æ£€æµ‹æ¡ä»¶**: ç›¸åŒå¹³å°ï¼ˆplatformï¼‰+ ç›¸åŒå¹³å°IDï¼ˆplatform_idï¼‰
2. **æ—¶é—´çª—å£**: 3å¤©å†…ï¼ˆåŒ…æ‹¬å½“å¤©ï¼‰
3. **å¤„ç†é€»è¾‘**:
   - 3å¤©å†…çš„ç›¸åŒè®°å½•ï¼šæ ‡è®°ä¸ºé‡å¤ï¼ˆ`is_duplicate: true`ï¼‰
   - è¶…è¿‡3å¤©çš„ç›¸åŒè®°å½•ï¼šè§†ä¸ºæ–°å®¢èµ„ï¼ˆ`is_duplicate: false`ï¼‰

### 1.4 è¯·æ±‚ç¤ºä¾‹

#### 1.4.1 cURL ç¤ºä¾‹

```bash
curl -X POST http://localhost:8000/api/data-records \
  -H "Authorization: Bearer 1|abcdefghijklmnopqrstuvwxyz123456789" \
  -H "Content-Type: application/json" \
  -d '{
    "image_url": "https://example.com/images/product.jpg",
    "platform": "douyin",
    "platform_id": "DY123456789"
  }'
```

#### 1.4.2 JavaScript ç¤ºä¾‹

```javascript
const createDataRecord = async (recordData) => {
  try {
    const response = await fetch('http://localhost:8000/api/data-records', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer 1|abcdefghijklmnopqrstuvwxyz123456789',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        image_url: recordData.imageUrl,
        platform: recordData.platform,
        platform_id: recordData.platformId
      })
    });

    const result = await response.json();
    
    if (result.success) {
      console.log('åˆ›å»ºæˆåŠŸ:', result.data);
      return result.data;
    } else {
      console.error('åˆ›å»ºå¤±è´¥:', result.message);
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥:', error);
    throw error;
  }
};

// ä½¿ç”¨ç¤ºä¾‹
createDataRecord({
  imageUrl: 'https://example.com/images/product.jpg',
  platform: 'douyin',
  platformId: 'DY123456789'
});
```

#### 1.4.3 Vue 3 ç¤ºä¾‹

```vue
<template>
  <div class="create-record-form">
    <form @submit.prevent="submitRecord">
      <div class="form-group">
        <label for="imageUrl">å›¾ç‰‡URL:</label>
        <input 
          id="imageUrl"
          v-model="form.imageUrl" 
          type="url" 
          required 
          placeholder="https://example.com/image.jpg"
        />
      </div>
      
      <div class="form-group">
        <label for="platform">æ¥æºå¹³å°:</label>
        <select id="platform" v-model="form.platform" required>
          <option value="">è¯·é€‰æ‹©å¹³å°</option>
          <option value="douyin">æŠ–éŸ³</option>
          <option value="xiaohongshu">å°çº¢ä¹¦</option>
          <option value="taobao">æ·˜å®</option>
          <option value="xianyu">é—²é±¼</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="platformId">å¹³å°ID:</label>
        <input 
          id="platformId"
          v-model="form.platformId" 
          type="text" 
          required 
          maxlength="255"
          placeholder="è¯·è¾“å…¥å¹³å°ID"
        />
      </div>
      
      <button type="submit" :disabled="isSubmitting">
        {{ isSubmitting ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºè®°å½•' }}
      </button>
    </form>
    
    <!-- é‡å¤æç¤º -->
    <div v-if="duplicateWarning" class="warning">
      âš ï¸ æ£€æµ‹åˆ°å¯èƒ½çš„é‡å¤è®°å½•ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨æ ‡è®°
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue'
import axios from 'axios'

// è¡¨å•æ•°æ®
const form = reactive({
  imageUrl: '',
  platform: '',
  platformId: ''
})

// çŠ¶æ€ç®¡ç†
const isSubmitting = ref(false)
const duplicateWarning = ref(false)

// æäº¤è®°å½•
const submitRecord = async () => {
  isSubmitting.value = true
  duplicateWarning.value = false
  
  try {
    const response = await axios.post('/api/data-records', {
      image_url: form.imageUrl,
      platform: form.platform,
      platform_id: form.platformId
    }, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    })
    
    if (response.data.success) {
      console.log('åˆ›å»ºæˆåŠŸ:', response.data.data)
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤è®°å½•
      if (response.data.data.is_duplicate) {
        duplicateWarning.value = true
      }
      
      // é‡ç½®è¡¨å•
      Object.assign(form, {
        imageUrl: '',
        platform: '',
        platformId: ''
      })
      
      // å¯ä»¥è§¦å‘æˆåŠŸå›è°ƒæˆ–è·³è½¬
      // emit('recordCreated', response.data.data)
    }
  } catch (error) {
    console.error('åˆ›å»ºå¤±è´¥:', error.response?.data || error.message)
    
    // å¤„ç†éªŒè¯é”™è¯¯
    if (error.response?.status === 422) {
      const errors = error.response.data.errors
      console.log('éªŒè¯é”™è¯¯:', errors)
      // æ˜¾ç¤ºå…·ä½“çš„éªŒè¯é”™è¯¯ä¿¡æ¯
    }
  } finally {
    isSubmitting.value = false
  }
}
</script>

<style scoped>
.create-record-form {
  max-width: 500px;
  margin: 0 auto;
  padding: 20px;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

button {
  width: 100%;
  padding: 10px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  cursor: pointer;
}

button:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
}

.warning {
  margin-top: 15px;
  padding: 10px;
  background-color: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 4px;
  color: #856404;
}
</style>
```

### 1.5 å“åº”ç¤ºä¾‹

#### 1.5.1 åˆ›å»ºæˆåŠŸ (201)

```json
{
  "success": true,
  "message": "åˆ›å»ºæ•°æ®è®°å½•æˆåŠŸ",
  "data": {
    "id": 123,
    "image_url": "https://example.com/images/product.jpg",
    "submitter_id": 1,
    "platform": "douyin",
    "platform_id": "DY123456789",
    "is_claimed": false,
    "is_completed": false,
    "claimer_id": null,
    "is_duplicate": false,
    "created_at": "2024-01-20T10:30:00.000000Z",
    "updated_at": "2024-01-20T10:30:00.000000Z",
    "submitter": {
      "id": 1,
      "name": "å¼ ä¸‰",
      "email": "zhangsan@example.com"
    },
    "claimer": null,
    "platform_name": "æŠ–éŸ³",
    "status_description": "å¾…é¢†å–"
  }
}
```

#### 1.5.2 é‡å¤è®°å½•åˆ›å»ºæˆåŠŸ (201)

```json
{
  "success": true,
  "message": "åˆ›å»ºæ•°æ®è®°å½•æˆåŠŸ",
  "data": {
    "id": 124,
    "image_url": "https://example.com/images/product.jpg",
    "submitter_id": 1,
    "platform": "douyin",
    "platform_id": "DY123456789",
    "is_claimed": false,
    "is_completed": false,
    "claimer_id": null,
    "is_duplicate": true,
    "created_at": "2024-01-20T10:35:00.000000Z",
    "updated_at": "2024-01-20T10:35:00.000000Z",
    "submitter": {
      "id": 1,
      "name": "å¼ ä¸‰",
      "email": "zhangsan@example.com"
    },
    "claimer": null,
    "platform_name": "æŠ–éŸ³",
    "status_description": "é‡å¤è®°å½•"
  }
}
```

#### 1.5.3 å‚æ•°éªŒè¯å¤±è´¥ (422)

```json
{
  "success": false,
  "message": "å‚æ•°éªŒè¯å¤±è´¥",
  "errors": {
    "image_url": ["å›¾ç‰‡URLä¸èƒ½ä¸ºç©º"],
    "platform": ["æ¥æºå¹³å°å¿…é¡»æ˜¯ï¼šdouyin, xiaohongshu, taobao, xianyu"],
    "platform_id": ["å¹³å°IDä¸èƒ½ä¸ºç©º"]
  }
}
```

#### 1.5.4 è®¤è¯å¤±è´¥ (401)

```json
{
  "success": false,
  "message": "æœªè®¤è¯"
}
```

#### 1.5.5 æœåŠ¡å™¨é”™è¯¯ (500)

```json
{
  "success": false,
  "message": "åˆ›å»ºæ•°æ®è®°å½•å¤±è´¥",
  "error": "æ•°æ®åº“è¿æ¥å¤±è´¥"
}
```

### 1.6 ä¸šåŠ¡é€»è¾‘è¯´æ˜

1. **è‡ªåŠ¨å»é‡æœºåˆ¶**:
   - åŸºäºå¹³å°å’Œå¹³å°IDè¿›è¡Œå»é‡æ£€æµ‹
   - 3å¤©å†…çš„é‡å¤è®°å½•ä¼šè¢«æ ‡è®°ä¸º `is_duplicate: true`
   - è¶…è¿‡3å¤©çš„ç›¸åŒè®°å½•è§†ä¸ºæ–°å®¢èµ„ï¼Œä¸æ ‡è®°é‡å¤

2. **è®°å½•çŠ¶æ€**:
   - æ–°åˆ›å»ºçš„è®°å½•é»˜è®¤ä¸º"å¾…é¢†å–"çŠ¶æ€
   - `is_claimed: false` - æœªè¢«é¢†å–
   - `is_completed: false` - æœªå®Œæˆ
   - `is_duplicate` - æ ¹æ®å»é‡è§„åˆ™è‡ªåŠ¨è®¾ç½®

3. **ç”¨æˆ·å…³è”**:
   - `submitter_id` è‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰è®¤è¯ç”¨æˆ·
   - `claimer_id` åˆå§‹ä¸ºç©ºï¼Œç­‰å¾…å…¶ä»–ç”¨æˆ·é¢†å–

### 1.7 ä½¿ç”¨è¯´æ˜

1. **å‰ç«¯é›†æˆå»ºè®®**:
   - å®ç°è¡¨å•éªŒè¯ï¼Œç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
   - æä¾›å¹³å°é€‰æ‹©ä¸‹æ‹‰èœå•
   - æ˜¾ç¤ºé‡å¤è®°å½•è­¦å‘Šä¿¡æ¯
   - å®ç°é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ

2. **é”™è¯¯å¤„ç†**:
   - 422é”™è¯¯ï¼šæ˜¾ç¤ºå…·ä½“çš„éªŒè¯é”™è¯¯ä¿¡æ¯
   - 401é”™è¯¯ï¼šè·³è½¬åˆ°ç™»å½•é¡µé¢
   - 500é”™è¯¯ï¼šæ˜¾ç¤ºç³»ç»Ÿé”™è¯¯æç¤º

3. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**:
   - æä¾›å›¾ç‰‡URLé¢„è§ˆåŠŸèƒ½
   - å®ç°å¹³å°IDæ ¼å¼æç¤º
   - æ˜¾ç¤ºåˆ›å»ºè¿›åº¦å’Œç»“æœåé¦ˆ

---

## 2. å›¾ç‰‡ä¸Šä¼ æ¥å£

### 2.1 æ¥å£ä¿¡æ¯

- **æ¥å£è·¯å¾„**: `POST /api/images/upload`
- **æ¥å£æè¿°**: ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼Œæ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼
- **è®¤è¯è¦æ±‚**: éœ€è¦Bearer Tokenè®¤è¯
- **è¯·æ±‚æ–¹å¼**: POST
- **Content-Type**: `multipart/form-data`

### 2.2 è¯·æ±‚å¤´

```
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

### 2.3 è¯·æ±‚å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| image | file | æ˜¯ | å›¾ç‰‡æ–‡ä»¶ |

#### å‚æ•°éªŒè¯è§„åˆ™

- `image`: 
  - å¿…å¡«å­—æ®µï¼Œæ–‡ä»¶ç±»å‹
  - **æ”¯æŒæ ¼å¼**: jpeg, jpg, png, gif, webp
  - **æ–‡ä»¶å¤§å°**: æœ€å¤§5MB (5120KB)
  - **MIMEç±»å‹**: image/jpeg, image/png, image/gif, image/webp

#### æ–‡ä»¶é™åˆ¶è¯´æ˜

1. **æ ¼å¼é™åˆ¶**: ä»…æ”¯æŒå¸¸è§çš„å›¾ç‰‡æ ¼å¼ï¼Œç¡®ä¿å®‰å…¨æ€§
2. **å¤§å°é™åˆ¶**: 5MBä¸Šé™ï¼Œå¹³è¡¡å­˜å‚¨æˆæœ¬å’Œç”¨æˆ·ä½“éªŒ
3. **å®‰å…¨æ£€æŸ¥**: éªŒè¯æ–‡ä»¶å¤´ä¿¡æ¯ï¼Œé˜²æ­¢æ¶æ„æ–‡ä»¶ä¸Šä¼ 

### 2.4 è¯·æ±‚ç¤ºä¾‹

#### 2.4.1 cURL ç¤ºä¾‹

```bash
curl -X POST http://localhost:8000/api/images/upload \
  -H "Authorization: Bearer 1|abcdefghijklmnopqrstuvwxyz123456789" \
  -F "image=@/path/to/your/image.jpg"
```

#### 2.4.2 JavaScript ç¤ºä¾‹

```javascript
// åŸºç¡€ä¸Šä¼ åŠŸèƒ½
const uploadImage = async (file) => {
  const formData = new FormData();
  formData.append('image', file);

  try {
    const response = await fetch('http://localhost:8000/api/images/upload', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer 1|abcdefghijklmnopqrstuvwxyz123456789'
        // æ³¨æ„ï¼šä¸è¦æ‰‹åŠ¨è®¾ç½® Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®
      },
      body: formData
    });

    const result = await response.json();
    
    if (result.success) {
      console.log('ä¸Šä¼ æˆåŠŸ:', result.data);
      return result.data;
    } else {
      console.error('ä¸Šä¼ å¤±è´¥:', result.message);
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥:', error);
    throw error;
  }
};

// å¸¦è¿›åº¦æ˜¾ç¤ºçš„ä¸Šä¼ 
const uploadImageWithProgress = (file, onProgress) => {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    const formData = new FormData();
    formData.append('image', file);

    // ä¸Šä¼ è¿›åº¦ç›‘å¬
    xhr.upload.addEventListener('progress', (event) => {
      if (event.lengthComputable) {
        const percentComplete = (event.loaded / event.total) * 100;
        onProgress(Math.round(percentComplete));
      }
    });

    // è¯·æ±‚å®Œæˆç›‘å¬
    xhr.addEventListener('load', () => {
      if (xhr.status === 200) {
        const result = JSON.parse(xhr.responseText);
        if (result.success) {
          resolve(result.data);
        } else {
          reject(new Error(result.message));
        }
      } else {
        reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
      }
    });

    // é”™è¯¯ç›‘å¬
    xhr.addEventListener('error', () => {
      reject(new Error('ç½‘ç»œé”™è¯¯'));
    });

    // å‘é€è¯·æ±‚
    xhr.open('POST', 'http://localhost:8000/api/images/upload');
    xhr.setRequestHeader('Authorization', 'Bearer 1|abcdefghijklmnopqrstuvwxyz123456789');
    xhr.send(formData);
  });
};

// ä½¿ç”¨ç¤ºä¾‹
const fileInput = document.getElementById('imageInput');
fileInput.addEventListener('change', async (event) => {
  const file = event.target.files[0];
  if (file) {
    try {
      // æ–‡ä»¶å¤§å°æ£€æŸ¥
      if (file.size > 5 * 1024 * 1024) {
        alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
        return;
      }

      // æ–‡ä»¶ç±»å‹æ£€æŸ¥
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
      if (!allowedTypes.includes(file.type)) {
        alert('åªæ”¯æŒ JPEGã€PNGã€GIFã€WebP æ ¼å¼çš„å›¾ç‰‡');
        return;
      }

      const result = await uploadImageWithProgress(file, (progress) => {
        console.log(`ä¸Šä¼ è¿›åº¦: ${progress}%`);
      });
      
      console.log('ä¸Šä¼ æˆåŠŸï¼Œå›¾ç‰‡URL:', result.url);
    } catch (error) {
      console.error('ä¸Šä¼ å¤±è´¥:', error.message);
    }
  }
});
```

#### 2.4.3 Vue 3 ç¤ºä¾‹

```vue
<template>
  <div class="image-upload">
    <!-- æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
    <div 
      class="upload-area"
      :class="{ 'dragover': isDragOver }"
      @drop="handleDrop"
      @dragover.prevent="isDragOver = true"
      @dragleave="isDragOver = false"
      @click="triggerFileInput"
    >
      <input 
        ref="fileInput"
        type="file" 
        accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
        @change="handleFileSelect"
        style="display: none"
      />
      
      <div v-if="!selectedFile" class="upload-placeholder">
        <div class="upload-icon">ğŸ“</div>
        <p>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
        <p class="upload-hint">æ”¯æŒ JPEGã€PNGã€GIFã€WebP æ ¼å¼ï¼Œæœ€å¤§5MB</p>
      </div>
      
      <!-- å›¾ç‰‡é¢„è§ˆ -->
      <div v-else class="image-preview">
        <img :src="previewUrl" alt="é¢„è§ˆå›¾ç‰‡" />
        <div class="image-info">
          <p><strong>æ–‡ä»¶å:</strong> {{ selectedFile.name }}</p>
          <p><strong>å¤§å°:</strong> {{ formatFileSize(selectedFile.size) }}</p>
          <p><strong>ç±»å‹:</strong> {{ selectedFile.type }}</p>
        </div>
        <button @click="clearSelection" class="clear-btn">é‡æ–°é€‰æ‹©</button>
      </div>
    </div>
    
    <!-- ä¸Šä¼ è¿›åº¦ -->
    <div v-if="isUploading" class="upload-progress">
      <div class="progress-bar">
        <div 
          class="progress-fill" 
          :style="{ width: uploadProgress + '%' }"
        ></div>
      </div>
      <p>ä¸Šä¼ è¿›åº¦: {{ uploadProgress }}%</p>
    </div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="upload-actions">
      <button 
        @click="uploadImage" 
        :disabled="!selectedFile || isUploading"
        class="upload-btn"
      >
        {{ isUploading ? 'ä¸Šä¼ ä¸­...' : 'ä¸Šä¼ å›¾ç‰‡' }}
      </button>
    </div>
    
    <!-- ä¸Šä¼ ç»“æœ -->
    <div v-if="uploadResult" class="upload-result">
      <div class="result-success">
        <h4>âœ… ä¸Šä¼ æˆåŠŸï¼</h4>
        <p><strong>æ–‡ä»¶å:</strong> {{ uploadResult.filename }}</p>
        <p><strong>è®¿é—®åœ°å€:</strong> 
          <a :href="uploadResult.url" target="_blank">{{ uploadResult.url }}</a>
        </p>
        <button @click="copyUrl" class="copy-btn">å¤åˆ¶é“¾æ¥</button>
      </div>
    </div>
    
    <!-- é”™è¯¯ä¿¡æ¯ -->
    <div v-if="errorMessage" class="upload-error">
      <p>âŒ {{ errorMessage }}</p>
      <button @click="clearError" class="clear-error-btn">å…³é—­</button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import axios from 'axios'

// å“åº”å¼æ•°æ®
const fileInput = ref<HTMLInputElement>()
const selectedFile = ref<File | null>(null)
const previewUrl = ref<string>('')
const isUploading = ref(false)
const uploadProgress = ref(0)
const uploadResult = ref<any>(null)
const errorMessage = ref<string>('')
const isDragOver = ref(false)

// è®¡ç®—å±æ€§
const isValidFile = computed(() => {
  if (!selectedFile.value) return false
  
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp']
  const maxSize = 5 * 1024 * 1024 // 5MB
  
  return allowedTypes.includes(selectedFile.value.type) && 
         selectedFile.value.size <= maxSize
})

// è§¦å‘æ–‡ä»¶é€‰æ‹©
const triggerFileInput = () => {
  fileInput.value?.click()
}

// å¤„ç†æ–‡ä»¶é€‰æ‹©
const handleFileSelect = (event: Event) => {
  const target = event.target as HTMLInputElement
  const file = target.files?.[0]
  if (file) {
    setSelectedFile(file)
  }
}

// å¤„ç†æ‹–æ‹½ä¸Šä¼ 
const handleDrop = (event: DragEvent) => {
  event.preventDefault()
  isDragOver.value = false
  
  const files = event.dataTransfer?.files
  if (files && files.length > 0) {
    setSelectedFile(files[0])
  }
}

// è®¾ç½®é€‰ä¸­çš„æ–‡ä»¶
const setSelectedFile = (file: File) => {
  // æ–‡ä»¶ç±»å‹æ£€æŸ¥
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp']
  if (!allowedTypes.includes(file.type)) {
    errorMessage.value = 'åªæ”¯æŒ JPEGã€PNGã€GIFã€WebP æ ¼å¼çš„å›¾ç‰‡'
    return
  }
  
  // æ–‡ä»¶å¤§å°æ£€æŸ¥
  if (file.size > 5 * 1024 * 1024) {
    errorMessage.value = 'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB'
    return
  }
  
  selectedFile.value = file
  
  // ç”Ÿæˆé¢„è§ˆURL
  if (previewUrl.value) {
    URL.revokeObjectURL(previewUrl.value)
  }
  previewUrl.value = URL.createObjectURL(file)
  
  // æ¸…é™¤ä¹‹å‰çš„ç»“æœå’Œé”™è¯¯
  uploadResult.value = null
  errorMessage.value = ''
}

// æ¸…é™¤é€‰æ‹©
const clearSelection = () => {
  selectedFile.value = null
  if (previewUrl.value) {
    URL.revokeObjectURL(previewUrl.value)
    previewUrl.value = ''
  }
  uploadResult.value = null
  errorMessage.value = ''
  uploadProgress.value = 0
}

// ä¸Šä¼ å›¾ç‰‡
const uploadImage = async () => {
  if (!selectedFile.value || !isValidFile.value) return
  
  isUploading.value = true
  uploadProgress.value = 0
  errorMessage.value = ''
  
  const formData = new FormData()
  formData.append('image', selectedFile.value)
  
  try {
    const response = await axios.post('/api/images/upload', formData, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'multipart/form-data'
      },
      onUploadProgress: (progressEvent) => {
        if (progressEvent.total) {
          uploadProgress.value = Math.round(
            (progressEvent.loaded * 100) / progressEvent.total
          )
        }
      }
    })
    
    if (response.data.success) {
      uploadResult.value = response.data.data
      console.log('ä¸Šä¼ æˆåŠŸ:', response.data.data)
    } else {
      errorMessage.value = response.data.message || 'ä¸Šä¼ å¤±è´¥'
    }
  } catch (error: any) {
    console.error('ä¸Šä¼ å¤±è´¥:', error)
    
    if (error.response?.status === 422) {
      const errors = error.response.data.errors
      if (errors.image) {
        errorMessage.value = errors.image[0]
      } else {
        errorMessage.value = 'å‚æ•°éªŒè¯å¤±è´¥'
      }
    } else if (error.response?.status === 401) {
      errorMessage.value = 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•'
    } else {
      errorMessage.value = error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•'
    }
  } finally {
    isUploading.value = false
  }
}

// å¤åˆ¶URL
const copyUrl = async () => {
  if (uploadResult.value?.url) {
    try {
      await navigator.clipboard.writeText(uploadResult.value.url)
      alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
    } catch (error) {
      console.error('å¤åˆ¶å¤±è´¥:', error)
      // é™çº§æ–¹æ¡ˆ
      const textArea = document.createElement('textarea')
      textArea.value = uploadResult.value.url
      document.body.appendChild(textArea)
      textArea.select()
      document.execCommand('copy')
      document.body.removeChild(textArea)
      alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
    }
  }
}

// æ¸…é™¤é”™è¯¯
const clearError = () => {
  errorMessage.value = ''
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
const formatFileSize = (bytes: number): string => {
  if (bytes === 0) return '0 Bytes'
  
  const k = 1024
  const sizes = ['Bytes', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
}

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†URL
import { onUnmounted } from 'vue'
onUnmounted(() => {
  if (previewUrl.value) {
    URL.revokeObjectURL(previewUrl.value)
  }
})
</script>

<style scoped>
.image-upload {
  max-width: 600px;
  margin: 0 auto;
  padding: 20px;
}

.upload-area {
  border: 2px dashed #ddd;
  border-radius: 8px;
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 20px;
}

.upload-area:hover,
.upload-area.dragover {
  border-color: #007bff;
  background-color: #f8f9fa;
}

.upload-placeholder .upload-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.upload-placeholder p {
  margin: 8px 0;
  color: #666;
}

.upload-hint {
  font-size: 12px;
  color: #999;
}

.image-preview {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

.image-preview img {
  max-width: 300px;
  max-height: 200px;
  object-fit: contain;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.image-info {
  text-align: left;
  background: #f8f9fa;
  padding: 12px;
  border-radius: 4px;
  width: 100%;
  max-width: 300px;
}

.image-info p {
  margin: 4px 0;
  font-size: 14px;
}

.clear-btn {
  padding: 6px 12px;
  background: #6c757d;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.upload-progress {
  margin-bottom: 20px;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: #e9ecef;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}

.progress-fill {
  height: 100%;
  background: #007bff;
  transition: width 0.3s ease;
}

.upload-actions {
  text-align: center;
  margin-bottom: 20px;
}

.upload-btn {
  padding: 12px 24px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  cursor: pointer;
  min-width: 120px;
}

.upload-btn:disabled {
  background: #6c757d;
  cursor: not-allowed;
}

.upload-result {
  background: #d4edda;
  border: 1px solid #c3e6cb;
  border-radius: 4px;
  padding: 16px;
  margin-bottom: 20px;
}

.result-success h4 {
  margin: 0 0 12px 0;
  color: #155724;
}

.result-success p {
  margin: 8px 0;
  font-size: 14px;
}

.result-success a {
  color: #007bff;
  text-decoration: none;
  word-break: break-all;
}

.copy-btn {
  padding: 4px 8px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  margin-top: 8px;
}

.upload-error {
  background: #f8d7da;
  border: 1px solid #f5c6cb;
  border-radius: 4px;
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.upload-error p {
  margin: 0;
  color: #721c24;
}

.clear-error-btn {
  padding: 4px 8px;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}
</style>
```

### 2.5 å“åº”ç¤ºä¾‹

#### 2.5.1 ä¸Šä¼ æˆåŠŸ (200)

```json
{
  "success": true,
  "message": "å›¾ç‰‡ä¸Šä¼ æˆåŠŸ",
  "data": {
    "filename": "550e8400-e29b-41d4-a716-446655440000.jpg",
    "url": "http://localhost:8000/images/550e8400-e29b-41d4-a716-446655440000.jpg",
    "size": 1024000,
    "original_name": "my-photo.jpg",
    "mime_type": "image/jpeg",
    "created_at": "2024-01-20T10:30:00.000000Z"
  }
}
```

#### 2.5.2 å‚æ•°éªŒè¯å¤±è´¥ (422)

**æœªé€‰æ‹©æ–‡ä»¶**:
```json
{
  "success": false,
  "message": "å›¾ç‰‡ä¸Šä¼ å¤±è´¥",
  "errors": {
    "image": ["è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡"]
  }
}
```

**æ–‡ä»¶æ ¼å¼é”™è¯¯**:
```json
{
  "success": false,
  "message": "å›¾ç‰‡ä¸Šä¼ å¤±è´¥",
  "errors": {
    "image": ["å›¾ç‰‡æ ¼å¼å¿…é¡»æ˜¯ï¼šjpeg, jpg, png, gif, webp"]
  }
}
```

**æ–‡ä»¶å¤§å°è¶…é™**:
```json
{
  "success": false,
  "message": "å›¾ç‰‡ä¸Šä¼ å¤±è´¥",
  "errors": {
    "image": ["å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB"]
  }
}
```

#### 2.5.3 è®¤è¯å¤±è´¥ (401)

```json
{
  "success": false,
  "message": "æœªè®¤è¯"
}
```

#### 2.5.4 æœåŠ¡å™¨é”™è¯¯ (500)

```json
{
  "success": false,
  "message": "å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼šå­˜å‚¨ç©ºé—´ä¸è¶³"
}
```

### 2.6 ä¸šåŠ¡é€»è¾‘è¯´æ˜

1. **æ–‡ä»¶å¤„ç†æµç¨‹**:
   - éªŒè¯ç”¨æˆ·è®¤è¯çŠ¶æ€
   - æ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œå¤§å°é™åˆ¶
   - ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼ˆä½¿ç”¨UUIDï¼‰
   - å°†æ–‡ä»¶ä¿å­˜åˆ° `public/images` ç›®å½•
   - è¿”å›æ–‡ä»¶è®¿é—®URLå’Œç›¸å…³ä¿¡æ¯

2. **æ–‡ä»¶å‘½åè§„åˆ™**:
   - ä½¿ç”¨UUIDç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
   - ä¿ç•™åŸå§‹æ–‡ä»¶æ‰©å±•å
   - æ ¼å¼ï¼š`{uuid}.{extension}`
   - ç¤ºä¾‹ï¼š`550e8400-e29b-41d4-a716-446655440000.jpg`

3. **å­˜å‚¨ä½ç½®**:
   - æœåŠ¡å™¨è·¯å¾„ï¼š`backend/public/images/`
   - è®¿é—®URLï¼š`http://localhost:8000/images/{filename}`

4. **å®‰å…¨æªæ–½**:
   - ä¸¥æ ¼çš„æ–‡ä»¶ç±»å‹éªŒè¯ï¼ˆåŸºäºMIMEç±»å‹å’Œæ–‡ä»¶æ‰©å±•åï¼‰
   - æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ5MBï¼‰
   - ç”¨æˆ·è®¤è¯è¦æ±‚
   - å”¯ä¸€æ–‡ä»¶åé˜²æ­¢å†²çªå’Œè¦†ç›–
   - æ–‡ä»¶å¤´æ£€æŸ¥é˜²æ­¢æ¶æ„æ–‡ä»¶

### 2.7 ä½¿ç”¨è¯´æ˜

1. **å‰ç«¯é›†æˆå»ºè®®**:
   - ä½¿ç”¨ `<input type="file">` æˆ–æ‹–æ‹½ä¸Šä¼ 
   - é€šè¿‡ FormData æ„å»ºè¯·æ±‚ä½“
   - ä¸è¦æ‰‹åŠ¨è®¾ç½® Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®
   - å®ç°ä¸Šä¼ è¿›åº¦æ˜¾ç¤º

2. **é”™è¯¯å¤„ç†**:
   - 422é”™è¯¯ï¼šæ˜¾ç¤ºå…·ä½“çš„éªŒè¯é”™è¯¯ä¿¡æ¯
   - 401é”™è¯¯ï¼šè·³è½¬åˆ°ç™»å½•é¡µé¢
   - 500é”™è¯¯ï¼šæ˜¾ç¤ºç³»ç»Ÿé”™è¯¯æç¤ºï¼Œå¯å®ç°é‡è¯•æœºåˆ¶

3. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**:
   - å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
   - æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
   - ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
   - æ–‡ä»¶å¤§å°å’Œæ ¼å¼æç¤º
   - ä¸Šä¼ ç»“æœå±•ç¤ºå’Œé“¾æ¥å¤åˆ¶

4. **æ€§èƒ½ä¼˜åŒ–**:
   - å®¢æˆ·ç«¯æ–‡ä»¶å¤§å°é¢„æ£€æŸ¥
   - å›¾ç‰‡å‹ç¼©ï¼ˆå¯é€‰ï¼‰
   - æ–­ç‚¹ç»­ä¼ ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š
- **é‚®ç®±**: developer@example.com
- **æ–‡æ¡£æ›´æ–°**: 2024-01-22
- **ç‰ˆæœ¬**: v1.0.0